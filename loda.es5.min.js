!function(){var e,o={x:0,y:0},a={x:0,y:0},n=Math,t=n.pow,r=document,c=function(e){return n.min(200,n.max(-200,e))},i=function(e,o,a){return e.dispatchEvent(new CustomEvent(o,{detail:a}))},d=function(){var n={x:c(4*(a.x-o.x)),y:c(4*(a.y-o.y))},d={x:a.x+n.x,y:a.y+n.y,d:t(t(n.x,2)+t(n.y,2),.5)};i(r,"precursormove",{x:d.x,y:d.y,d:d.d}),function(o){var a=r.elementFromPoint(o.x,o.y),n=[],t=[],c=e;if(!e||a&&a===e||(e.classList.remove("prehover"),i(e,"erphover")),a&&e!==a){for(;c;)t.push(c=c.parentNode);for(c=a;c;)n.push(c=c.parentNode);for(var d=0,u=t;d<u.length;d++)(c=u[d])&&n.indexOf(c)<0&&c.classList.remove("prehover");for(var l=0,g=n;l<g.length;l++)(c=g[l])&&c.classList&&t.indexOf(c)<0&&c.classList.add("prehover");a.classList.add("prehover"),i(a,"prehover",{d:o.d}),e=a}}(d),o=a};r.addEventListener("mousemove",function(e){a={x:e.clientX,y:e.clientY},d()})}();var changingHash,binderTimeout,cacheTimer,LODA_ID,LAST_PAGE,ignoreNav,queuedPage,deferredPageLoadSpooler,dispatchEventOnDocument=function(e,o){document.dispatchEvent(new CustomEvent(e,{detail:o}))},domLoaded=!1,loaded=!1,pageCache={},cachingPages={},loadedFor=[],SERVER="https://api.loda.rocks",USING_PROXY=!1,grab=function(e){return"string"==typeof e?document.getElementById(e):e},bind=function(e,o,a){return e.addEventListener(o,a)},load=function(e){return bind(window,"DOMContentLoaded",e)},loader=function(){deferredPageLoadSpooler&&(clearTimeout(deferredPageLoadSpooler),deferredPageLoadSpooler=null),dispatchEventOnDocument("page-loading",{o:pageCache}),binderTimeout&&clearTimeout(binderTimeout),binderTimeout=setTimeout(actualLoader,10)},actualLoader=function(){if(document.body){loaded&&(dispatchEventOnDocument("page-loaded"),[document,window].forEach(function(e){e.dispatchEvent(new UIEvent("load"))})),LAST_PAGE=location.href;var e=document.getElementsByTagName("a"),o=document.createElement("a"),a=location.hostname,n=location.href.indexOf("#");-1==n&&(n=location.href.length);for(var t=function(t){var r=e[t].href,c=r.indexOf("#");-1==c&&(c=r.length),e[t].href&&!e[t].getAttribute("loda-bound")&&!e[t].getAttribute("loda-disabled")&&e[t].href.match(/^https?:\/\//)&&!e[t].getAttribute("target")&&(location.href.match(/^(.+?):\/\//)||[0])[1]==(r.match(/^(.+?):\/\//)||[0])[1]&&e[t].href.match(RegExp("^https?://"+a+"([:/#]|$)"))&&(r.substring(0,c)!=location.href.substring(0,n)?(e[t].addEventListener("prehover",function(){startHover({target:e[t]})}),e[t].addEventListener("mousedown",clickLink),o.href=e[t].getAttribute("href"),e[t].setAttribute("loda-bound","true")):e[t].addEventListener("click",ignoreNav))},r=0;r<e.length;r++)t(r);var c,i=grab("loda-script");if(i){c=i.getAttribute("loda-id"),LODA_ID=c;var d=i.getAttribute("loda-proxy");SERVER=d||"https://api.loda.rocks",USING_PROXY=!!d}("string"==typeof LODA_ID||USING_PROXY)&&loadedFor.indexOf(location.href)<0&&(pollServer(location.href,null),loadedFor.push(location.href)),dispatchEventOnDocument("page-prepped"),loaded=!0}else loader()};load(loader);var pollServer=function(e,o){var a=new XMLHttpRequest;a.addEventListener("load",function(){var e=JSON.parse(a.response),o=e.pages;if(o)for(var n=0,t=o;n<t.length;n++){var r=t[n];cachePage(r)}else dispatchEventOnDocument("api-error",{error:e.t})});var n=document.createElement("a");n.href=e;var t={action:"loading_page",i:n.href,u:LODA_ID};o&&(n.href=o,t.l=n.href),a.open("POST",SERVER),a.send(JSON.stringify(t))},clickLink=function(e){var o;if("string"==typeof e)o=e;else{if(o=e.target,e.button)return;for(0===e.button&&e.preventDefault(),makeDeferredPageLoadSpooler();o&&!o.href;)o=o.parentNode;o=o.href}var a=LAST_PAGE;loadPage(o),"string"==typeof LODA_ID&&pollServer(o,a)},loadPage=function(e,o){LAST_PAGE=e,pageCache[e]?setTimeout(function(){showPage(e,o)},0):cachePage(e,!0,o)};function makeDeferredPageLoadSpooler(){deferredPageLoadSpooler||(deferredPageLoadSpooler=setTimeout(function(){var e=document.body;e.style.cursor="none",e.style.pointerEvents="none",e.style.opacity=".5"},500))}var startHover=function(e){for(var o=e.target;o&&"function"==typeof o.getAttribute&&!o.href;)o=o.parentNode;o&&"function"==typeof o.getAttribute&&(o=o.href,cacheTimer&&clearTimeout(cacheTimer),cacheTimer=setTimeout(function(){cachePage(o)},0))},cachePage=function(e,o,a){if(o&&(queuedPage=e,dispatchEventOnDocument("page-queued",{page:e})),!cachingPages[e]){cachingPages[e]=!0;var n=storedPageFor(e);if(getSiteVersion()>-1&&n&&n.version>=getSiteVersion())pageCache[e]=n.content,dispatchEventOnDocument("permacache-hit",{page:e}),queuedPage&&showPage(e,a);else{var t=new XMLHttpRequest;t.addEventListener("load",function(){pageCache[e]=t.response,dispatchEventOnDocument("page-cached",{page:e,content:t.content}),cleanCache(t.response.length),getSiteVersion()>-1&&getCacheSize()+t.response.length<4e6&&(localStorage.setItem(e,JSON.stringify({content:t.response,version:getSiteVersion(),g:+new Date,p:+new Date,s:"Loda"})),dispatchEventOnDocument("page-permacached")),queuedPage&&showPage(queuedPage,a)}),t.open("GET",e),t.send()}}},showPage=function(e,o){var a;if(e){if(!(a=pageCache[e]))return;window.document.open(),window.document.write(a),window.document.close(),console.log("OPENED WROTE CLOSED",a),o||history.pushState({page:e},null,e),setTimeout(function(){loader()},0)}else cachePage("index.html",!0,!0)},popPage=function(e){null===e.state&&changingHash?changingHash=!1:location.reload()};ignoreNav=function(){changingHash=!0};var getSiteVersion=function(){var e=grab("loda-script");return e&&e.getAttribute("site-version")||-1},storedPageFor=function(e){var o=localStorage.getItem(e);return o?JSON.parse(o):0},getCacheSize=function(){for(var e=0,o=0,a=localStorage.length;o<a;++o){var n=localStorage.key(o),t=localStorage.getItem(n),r=void 0;try{r=JSON.parse(t)}catch(e){continue}"Loda"==r.s&&(e+=r.content.length)}return e},cleanCache=function(e){for(var o=getCacheSize();o+e>4e6&&o>0;){o=0;for(var a=+new Date,n=void 0,t=0,r=localStorage.length;t<r;++t){var c=localStorage.key(t),i=localStorage.getItem(c),d=void 0;try{d=JSON.parse(i)}catch(e){continue}"Loda"==d.s&&(o+=d.content.length,d.p<a&&(a=d.p,n=c))}n&&(localStorage.removeItem(n),dispatchEventOnDocument("pageCache-trimmed",{page:n}))}dispatchEventOnDocument("pageCache-cleaned")};bind(window,"DOMContentLoaded",function(){domLoaded=!0});try{window.removeEventListener("popstate",popPage)}catch(e){console.log("popstate rebound")}window.addEventListener("popstate",popPage);
//# sourceMappingURL=loda.es5.min.js